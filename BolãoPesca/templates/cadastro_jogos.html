<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cadastro de Jogos - Bolão dos Pescadores</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/cadastro_jogos.css') }}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <div class="container">
        <!-- Header -->
        <header class="header">
            <div class="logo-container">
                <i class="fas fa-fish logo-icon"></i>
                <h1 class="logo">Bolão dos Pescadores</h1>
            </div>
            <nav class="nav-menu">
                <a href="{{ url_for('index') }}" class="nav-link">
                    <i class="fas fa-home"></i> Início
                </a>
                <a href="{{ url_for('cadastro_participantes') }}" class="nav-link">
                    <i class="fas fa-users"></i> Participantes
                </a>
            </nav>
        </header>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Page Header -->
            <div class="page-header">
                <div>
                    <h1><i class="fas fa-futbol"></i> Cadastro de Jogos</h1>
                    <p class="page-subtitle">Gerencie rodadas e jogos do campeonato (38 rodadas, 10 jogos cada)</p>
                </div>
                <div class="header-stats">
                    <div class="mini-stat">
                        <i class="fas fa-calendar-alt"></i>
                        <div>
                            <span class="mini-stat-number">{{ estatisticas.total_rodadas }}</span>
                            <span class="mini-stat-label">Rodadas</span>
                        </div>
                    </div>
                    <div class="mini-stat">
                        <i class="fas fa-futbol"></i>
                        <div>
                            <span class="mini-stat-number">{{ estatisticas.jogos_cadastrados }}</span>
                            <span class="mini-stat-label">Jogos</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Flash Messages -->
            {% with messages = get_flashed_messages(with_categories=true) %}
                {% if messages %}
                    <div class="flash-messages">
                        {% for category, message in messages %}
                            <div class="flash flash-{{ category }}">
                                {{ message }}
                                <button class="flash-close" onclick="this.parentElement.remove()">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                        {% endfor %}
                    </div>
                {% endif %}
            {% endwith %}

            <!-- Two Columns Layout -->
            <div class="columns-container">
                <!-- Left Column: Rodadas -->
                <div class="left-column">
                    <!-- Criar Nova Rodada -->
                    <div class="card">
                        <div class="card-header">
                            <h3><i class="fas fa-plus-circle"></i> Criar Nova Rodada</h3>
                        </div>
                        <div class="card-body">
                            <form method="POST" action="{{ url_for('cadastro_jogos') }}" class="create-round-form">
                                <div class="form-grid">
                                    <div class="form-group">
                                        <label for="numero">
                                            <i class="fas fa-hashtag"></i> Número da Rodada *
                                        </label>
                                        <input type="number"
                                               id="numero"
                                               name="numero"
                                               min="1"
                                               max="38"
                                               required
                                               placeholder="1 a 38">
                                    </div>

                                    <div class="form-group">
                                        <label for="nome">
                                            <i class="fas fa-tag"></i> Nome da Rodada *
                                        </label>
                                        <input type="text"
                                               id="nome"
                                               name="nome"
                                               required
                                               placeholder="Ex: Rodada 1 - Abertura">
                                    </div>
                                </div>

                                <button type="submit" class="btn-submit">
                                    <i class="fas fa-save"></i> Criar Rodada
                                </button>
                            </form>
                        </div>
                    </div>

                    <!-- Lista de Rodadas -->
                    <div class="card">
                        <div class="card-header">
                            <h3><i class="fas fa-list-ol"></i> Rodadas do Campeonato</h3>
                        </div>
                        <div class="card-body">
                            <div class="rounds-list">
                                {% for rodada in rounds %}
                                <div class="round-item {% if rodada.status == 'Concluída' %}completed{% elif rodada.status == 'Em andamento' %}active{% endif %}">
                                    <div class="round-info">
                                        <div class="round-header">
                                            <span class="round-number">Rodada {{ rodada.numero }}</span>
                                            <span class="round-status-badge {{ rodada.status|lower|replace(' ', '-') }}">
                                                {{ rodada.status }}
                                            </span>
                                        </div>
                                        <div class="round-details">
                                            <span class="round-name">{{ rodada.nome }}</span>
                                        </div>
                                        <div class="round-games-count">
                                            <i class="fas fa-futbol"></i>
                                            <span>{{ games.get(rodada.numero|string, [])|length }} / 10 jogos</span>
                                        </div>
                                    </div>

                                    <div class="round-actions">
                                        <button class="btn-action btn-sm"
                                                onclick="carregarRodada({{ rodada.numero }})">
                                            <i class="fas fa-edit"></i> Gerenciar
                                        </button>

                                        <form method="POST"
                                              action="{{ url_for('atualizar_status_rodada', rodada_numero=rodada.numero) }}"
                                              class="status-form">
                                            <select name="status"
                                                    class="status-select"
                                                    onchange="this.form.submit()">
                                                <option value="Não iniciada" {% if rodada.status == 'Não iniciada' %}selected{% endif %}>
                                                    Não iniciada
                                                </option>
                                                <option value="Em andamento" {% if rodada.status == 'Em andamento' %}selected{% endif %}>
                                                    Em andamento
                                                </option>
                                                <option value="Concluída" {% if rodada.status == 'Concluída' %}selected{% endif %}>
                                                    Concluída
                                                </option>
                                            </select>
                                        </form>
                                    </div>
                                </div>
                                {% else %}
                                <div class="empty-state-small">
                                    <i class="fas fa-calendar-plus"></i>
                                    <p>Nenhuma rodada criada ainda</p>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Right Column: Jogos da Rodada -->
                <div class="right-column">
                    <div class="card">
                        <div class="card-header">
                            <h3><i class="fas fa-futbol"></i> Jogos da Rodada</h3>
                            <div class="current-round-info" id="currentRoundInfo">
                                Selecione uma rodada para gerenciar os jogos
                            </div>
                        </div>

                        <div class="card-body">
                            <!-- Formulário para Adicionar/Editar Jogo -->
                            <div class="add-game-form-container" id="addGameForm" style="display: none;">
                                <h4 id="formTitle"><i class="fas fa-plus"></i> Adicionar Novo Jogo</h4>
                                <form method="POST" action="{{ url_for('salvar_jogo') }}" id="gameForm" class="game-form">
                                    <input type="hidden" id="rodada_numero" name="rodada_numero" value="">
                                    <input type="hidden" id="jogo_id" name="jogo_id" value="">

                                    <div class="form-grid">
                                        <div class="form-group">
                                            <label for="time_casa">
                                                <i class="fas fa-home"></i> Time da Casa *
                                            </label>
                                            <input type="text"
                                                   id="time_casa"
                                                   name="time_casa"
                                                   required
                                                   placeholder="Digite o time da casa"
                                                   list="timesList"
                                                   autocomplete="off">
                                            <datalist id="timesList">
                                                {% for time in times %}
                                                <option value="{{ time }}">
                                                {% endfor %}
                                            </datalist>
                                        </div>

                                        <div class="form-group">
                                            <label for="time_visitante">
                                                <i class="fas fa-plane-departure"></i> Time Visitante *
                                            </label>
                                            <input type="text"
                                                   id="time_visitante"
                                                   name="time_visitante"
                                                   required
                                                   placeholder="Digite o time visitante"
                                                   list="timesList"
                                                   autocomplete="off">
                                        </div>

                                        <div class="form-group">
                                            <label for="data">
                                                <i class="fas fa-calendar-day"></i> Data do Jogo
                                            </label>
                                            <input type="date"
                                                   id="data"
                                                   name="data">
                                        </div>

                                        <div class="form-group">
                                            <label for="horario">
                                                <i class="fas fa-clock"></i> Horário
                                            </label>
                                            <input type="time"
                                                   id="horario"
                                                   name="horario"
                                                   value="16:00">
                                        </div>

                                        <div class="form-group">
                                            <label for="estadio">
                                                <i class="fas fa-archway"></i> Estádio
                                            </label>
                                            <input type="text"
                                                   id="estadio"
                                                   name="estadio"
                                                   placeholder="Nome do estádio">
                                        </div>
                                    </div>

                                    <div class="form-actions">
                                        <button type="submit" class="btn-submit">
                                            <i class="fas fa-save"></i> Salvar Jogo
                                        </button>
                                        <button type="button" class="btn-cancel" onclick="cancelarEdicao()">
                                            <i class="fas fa-times"></i> Cancelar
                                        </button>
                                    </div>
                                </form>
                            </div>

                            <!-- Lista de Jogos -->
                            <div class="games-list-container" id="gamesList">
                                <div class="empty-state-large">
                                    <i class="fas fa-futbol"></i>
                                    <h3>Selecione uma rodada</h3>
                                    <p>Escolha uma rodada da lista ao lado para ver e gerenciar os jogos</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Quick Stats -->
                    <div class="quick-stats-card">
                        <h4><i class="fas fa-chart-pie"></i> Estatísticas Rápidas</h4>
                        <div class="stats-grid">
                            <div class="quick-stat">
                                <i class="fas fa-futbol"></i>
                                <div>
                                    <span class="quick-stat-number">{{ estatisticas.jogos_cadastrados }}</span>
                                    <span class="quick-stat-label">Jogos Cadastrados</span>
                                </div>
                            </div>
                            <div class="quick-stat">
                                <i class="fas fa-flag-checkered"></i>
                                <div>
                                    <span class="quick-stat-number">{{ rounds|selectattr('status', 'equalto', 'Concluída')|list|length }}</span>
                                    <span class="quick-stat-label">Rodadas Concluídas</span>
                                </div>
                            </div>
                            <div class="quick-stat">
                                <i class="fas fa-play-circle"></i>
                                <div>
                                    <span class="quick-stat-number">{{ rounds|selectattr('status', 'equalto', 'Em andamento')|list|length }}</span>
                                    <span class="quick-stat-label">Rodadas Ativas</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Controles Administrativos -->
            <div class="admin-controls-card">
                <h4><i class="fas fa-shield-alt"></i> Controles Administrativos</h4>
                <div class="admin-controls-grid">
                    <div class="admin-control">
                        <i class="fas fa-undo"></i>
                        <div class="admin-control-info">
                            <h5>Resetar Jogos Concluídos</h5>
                            <p>Volta jogos concluídos para "Agendado" e zera placares</p>
                            <button type="button"
                                    class="btn-reset"
                                    onclick="abrirModalReset()"
                                    {% if not session.get('is_admin', false) %}disabled title="Apenas administradores podem usar esta função"{% endif %}>
                                <i class="fas fa-exclamation-triangle"></i> Resetar Jogos
                            </button>
                        </div>
                    </div>

                    <div class="admin-control">
                        <i class="fas fa-sync"></i>
                        <div class="admin-control-info">
                            <h5>Atualizar Ranking</h5>
                            <p>Força atualização das pontuações</p>
                            <a href="{{ url_for('atualizar_ranking') }}" class="btn-refresh">
                                <i class="fas fa-sync-alt"></i> Atualizar
                            </a>
                        </div>
                    </div>
                </div>

                <div class="admin-hint">
                    <i class="fas fa-info-circle"></i>
                    <small>Para acessar todas as funcionalidades, ative o modo admin em <a href="{{ url_for('modo_admin') }}">/modo-admin</a></small>
                </div>
            </div>

            <!-- Modal de Confirmação para Resetar Jogos -->
            <div class="modal-overlay" id="resetModal" style="display: none;">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">
                                <i class="fas fa-exclamation-triangle text-danger"></i> Confirmar Reset de Jogos
                            </h5>
                            <button type="button" class="modal-close" onclick="fecharModalReset()">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        <div class="modal-body">
                            <div class="warning-message">
                                <i class="fas fa-exclamation-circle"></i>
                                <div>
                                    <h6>ATENÇÃO: Esta ação não pode ser desfeita!</h6>
                                    <p>Ao confirmar, todos os jogos com status "Concluído" serão alterados:</p>
                                </div>
                            </div>

                            <ul class="reset-consequences">
                                <li><i class="fas fa-arrow-left"></i> Status mudará para <strong>"Agendado"</strong></li>
                                <li><i class="fas fa-eraser"></i> Placar será <strong>zerado</strong> (null)</li>
                                <li><i class="fas fa-calendar-times"></i> Data de conclusão será <strong>removida</strong></li>
                                <li><i class="fas fa-chart-line"></i> Ranking será <strong>recalculado</strong></li>
                                <li><i class="fas fa-history"></i> Pontuações serão <strong>perdidas</strong></li>
                            </ul>

                            <div class="reset-confirm">
                                <label class="confirm-checkbox">
                                    <input type="checkbox" id="confirmReset">
                                    <span>Eu entendo as consequências e desejo prosseguir</span>
                                </label>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn-modal-secondary" onclick="fecharModalReset()">
                                <i class="fas fa-times"></i> Cancelar
                            </button>
                            <a href="/cadastro-jogos/resetar-todos-jogos"
                               class="btn-modal-danger"
                               id="resetConfirmBtn"
                               onclick="return confirmReset()">
                                <i class="fas fa-check"></i> Sim, Resetar Todos os Jogos
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </main>

        <!-- Footer -->
        <footer class="footer">
            <div class="footer-content">
                <div class="footer-section">
                    <h3>Cadastro de Jogos</h3>
                    <p>Sistema de gerenciamento de rodadas e jogos</p>
                </div>
            </div>
            <div class="footer-bottom">
                <p>&copy; 2023 Bolão dos Pescadores</p>
            </div>
        </footer>
    </div>

    <!-- Templates para JavaScript -->
<template id="gameItemTemplate">
    <div class="game-item" data-jogo-id="">
        <div class="game-teams">
            <span class="team home-team"></span>
            <span class="vs">vs</span>
            <span class="team away-team"></span>
        </div>
        <div class="game-details">
            <span class="game-date"></span>
            <span class="game-time"></span>
            <span class="game-stadium"></span>
            <div class="game-score" style="display: none;">
                <span class="score"></span>
            </div>
        </div>
        <div class="game-status">
            <span class="status-badge"></span>
        </div>
        <div class="game-actions">
            <button class="btn-action btn-sm btn-edit">
                <i class="fas fa-edit"></i>
            </button>
            <button class="btn-action btn-sm btn-score">
                <i class="fas fa-futbol"></i>
            </button>
            <!-- Botão de reset agora é um botão, não um link -->
            <button class="btn-action btn-sm btn-reset" style="display: none;" title="Resetar jogo para Agendado">
                <i class="fas fa-undo"></i>
            </button>
            <button class="btn-action btn-sm btn-delete" title="Excluir jogo">
                <i class="fas fa-trash"></i>
            </button>
        </div>
    </div>
</template>

    <script>
    // Variáveis globais
    let rodadaAtual = null;

    // Carregar jogos de uma rodada
    async function carregarRodada(numero) {
        console.log(`Carregando rodada ${numero}`);
        rodadaAtual = numero;

        // Atualizar informação da rodada
        document.getElementById('currentRoundInfo').innerHTML = `
            <strong>Rodada ${numero}</strong> - Gerencie os 10 jogos desta rodada
        `;

        // Mostrar formulário de adicionar jogo
        const addGameForm = document.getElementById('addGameForm');
        addGameForm.style.display = 'block';

        // Configurar formulário
        const form = document.getElementById('gameForm');
        document.getElementById('rodada_numero').value = numero;
        document.getElementById('jogo_id').value = '';
        form.reset();
        document.getElementById('horario').value = '16:00';

        // Atualizar título
        document.getElementById('formTitle').innerHTML = '<i class="fas fa-plus"></i> Adicionar Novo Jogo';

        // Carregar jogos via API
        await carregarJogosRodada(numero);
    }

    // Função separada para carregar jogos
    async function carregarJogosRodada(numero) {
        try {
            const response = await fetch(`/api/rodada/${numero}/jogos`);
            const jogos = await response.json();
            console.log(`Jogos carregados: ${jogos.length}`);

            const gamesList = document.getElementById('gamesList');

            if (jogos.length === 0) {
                gamesList.innerHTML = `
                    <div class="empty-state-small">
                        <i class="fas fa-futbol"></i>
                        <p>Nenhum jogo cadastrado para esta rodada</p>
                        <p class="hint">Adicione os 10 jogos da rodada usando o formulário acima</p>
                    </div>
                `;
            } else {
                gamesList.innerHTML = '';

                jogos.forEach(jogo => {
                    const template = document.getElementById('gameItemTemplate').content.cloneNode(true);
                    const gameItem = template.querySelector('.game-item');

                    // Armazenar ID do jogo no elemento
                    gameItem.dataset.jogoId = jogo.id;

                    // Preencher dados
                    gameItem.querySelector('.home-team').textContent = jogo.time_casa;
                    gameItem.querySelector('.away-team').textContent = jogo.time_visitante;
                    gameItem.querySelector('.game-date').textContent = jogo.data ? formatarData(jogo.data) : 'A definir';
                    gameItem.querySelector('.game-time').textContent = jogo.horario;
                    gameItem.querySelector('.game-stadium').textContent = jogo.estadio || 'A definir';

                    // Status
                    const statusBadge = gameItem.querySelector('.status-badge');
                    statusBadge.textContent = jogo.status;
                    statusBadge.className = `status-badge ${jogo.status.toLowerCase().replace(' ', '-')}`;

                    // Placar
                    const scoreDiv = gameItem.querySelector('.game-score');
                    if (jogo.placar_casa !== null && jogo.placar_visitante !== null) {
                        scoreDiv.style.display = 'block';
                        scoreDiv.querySelector('.score').textContent = `${jogo.placar_casa} - ${jogo.placar_visitante}`;
                    } else {
                        scoreDiv.style.display = 'none';
                    }

                    // Botão Editar
                    const editBtn = gameItem.querySelector('.btn-edit');
                    editBtn.onclick = () => editarJogo(jogo);

                    // Botão Registrar Placar
                    const scoreBtn = gameItem.querySelector('.btn-score');
                    scoreBtn.onclick = () => registrarPlacar(jogo.id);

                    // Botão Reset
                    const resetBtn = gameItem.querySelector('.btn-reset');
                    resetBtn.onclick = () => resetarJogo(jogo.id, jogo.time_casa, jogo.time_visitante);

                    // Mostrar botão de reset apenas se o jogo estiver concluído
                    if (jogo.status === 'Concluído') {
                        resetBtn.style.display = 'inline-flex';
                        scoreBtn.style.display = 'none'; // Não mostrar botão de placar se já está concluído
                    } else {
                        resetBtn.style.display = 'none';
                        scoreBtn.style.display = 'inline-flex';
                    }

                    // Botão Excluir
                    const deleteBtn = gameItem.querySelector('.btn-delete');
                    deleteBtn.onclick = () => excluirJogo(jogo.id, jogo.time_casa, jogo.time_visitante);

                    gamesList.appendChild(gameItem);
                });
            }
        } catch (error) {
            console.error('Erro ao carregar jogos:', error);
            const gamesList = document.getElementById('gamesList');
            gamesList.innerHTML = `
                <div class="error-state">
                    <i class="fas fa-exclamation-triangle"></i>
                    <p>Erro ao carregar jogos</p>
                    <p>${error.message}</p>
                </div>
            `;
        }
    }

    // Editar jogo
    function editarJogo(jogo) {
        console.log('Editando jogo:', jogo);

        // Preencher formulário
        document.getElementById('time_casa').value = jogo.time_casa;
        document.getElementById('time_visitante').value = jogo.time_visitante;
        document.getElementById('data').value = jogo.data || '';
        document.getElementById('horario').value = jogo.horario || '16:00';
        document.getElementById('estadio').value = jogo.estadio || '';
        document.getElementById('jogo_id').value = jogo.id;
        document.getElementById('rodada_numero').value = jogo.rodada;

        // Atualizar título
        document.getElementById('formTitle').innerHTML = '<i class="fas fa-edit"></i> Editar Jogo';

        // Scroll para formulário
        document.getElementById('addGameForm').scrollIntoView({ behavior: 'smooth' });
    }

    // Cancelar edição
    function cancelarEdicao() {
        console.log('Cancelando edição');
        const form = document.getElementById('gameForm');
        form.reset();
        document.getElementById('jogo_id').value = '';
        document.getElementById('horario').value = '16:00';

        if (rodadaAtual) {
            document.getElementById('rodada_numero').value = rodadaAtual;
        }

        // Restaurar título
        document.getElementById('formTitle').innerHTML = '<i class="fas fa-plus"></i> Adicionar Novo Jogo';
    }

    // Registrar placar
    function registrarPlacar(jogoId) {
        const placarCasa = prompt('Placar do time da casa:');
        if (placarCasa === null) return;

        const placarVisitante = prompt('Placar do time visitante:');
        if (placarVisitante === null) return;

        // Criar formulário dinâmico para enviar via POST
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = `/cadastro-jogos/placar/${jogoId}`;
        form.style.display = 'none';

        const inputCasa = document.createElement('input');
        inputCasa.type = 'hidden';
        inputCasa.name = 'placar_casa';
        inputCasa.value = placarCasa;

        const inputVisitante = document.createElement('input');
        inputVisitante.type = 'hidden';
        inputVisitante.name = 'placar_visitante';
        inputVisitante.value = placarVisitante;

        form.appendChild(inputCasa);
        form.appendChild(inputVisitante);
        document.body.appendChild(form);
        form.submit();
    }

    // Resetar jogo
    async function resetarJogo(jogoId, timeCasa, timeVisitante) {
        if (!confirm(`Deseja resetar o jogo ${timeCasa} x ${timeVisitante}?\n\nStatus: Concluído → Agendado\nPlacar: será zerado`)) {
            return;
        }

        try {
            const response = await fetch(`/cadastro-jogos/resetar-jogo/${jogoId}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                }
            });

            const result = await response.json();

            if (result.success) {
                // Mostrar mensagem de sucesso
                showFlashMessage(result.message, 'success');

                // Recarregar a rodada atual
                if (rodadaAtual) {
                    setTimeout(() => carregarJogosRodada(rodadaAtual), 500);
                }
            } else {
                showFlashMessage(result.message, 'error');
            }
        } catch (error) {
            console.error('Erro ao resetar jogo:', error);
            showFlashMessage('Erro ao resetar o jogo. Tente novamente.', 'error');
        }
    }

    // Excluir jogo
    async function excluirJogo(jogoId, timeCasa, timeVisitante) {
        if (!confirm(`Deseja excluir o jogo ${timeCasa} x ${timeVisitante}?\n\nEsta ação não pode ser desfeita!`)) {
            return;
        }

        try {
            const response = await fetch(`/cadastro-jogos/excluir/${jogoId}`);

            if (response.ok) {
                showFlashMessage('Jogo excluído com sucesso!', 'success');

                // Recarregar a rodada atual
                if (rodadaAtual) {
                    setTimeout(() => carregarJogosRodada(rodadaAtual), 500);
                }
            } else {
                showFlashMessage('Erro ao excluir o jogo.', 'error');
            }
        } catch (error) {
            console.error('Erro ao excluir jogo:', error);
            showFlashMessage('Erro ao excluir o jogo. Tente novamente.', 'error');
        }
    }

    // Formatar data
    function formatarData(dataString) {
        if (!dataString) return 'A definir';
        const data = new Date(dataString);
        return data.toLocaleDateString('pt-BR');
    }

    // Mostrar mensagem flash
    function showFlashMessage(message, type = 'info') {
        const flashDiv = document.createElement('div');
        flashDiv.className = `flash flash-${type}`;
        flashDiv.innerHTML = `
            ${message}
            <button class="flash-close" onclick="this.parentElement.remove()">
                <i class="fas fa-times"></i>
            </button>
        `;

        const flashMessages = document.querySelector('.flash-messages') || createFlashMessagesContainer();
        flashMessages.insertBefore(flashDiv, flashMessages.firstChild);

        // Auto-remove após 5 segundos
        setTimeout(() => {
            if (flashDiv.parentElement) {
                flashDiv.style.opacity = '0';
                setTimeout(() => flashDiv.remove(), 300);
            }
        }, 5000);
    }

    // Criar container para mensagens flash se não existir
    function createFlashMessagesContainer() {
        const container = document.createElement('div');
        container.className = 'flash-messages';
        const pageHeader = document.querySelector('.page-header');
        if (pageHeader && pageHeader.nextElementSibling) {
            pageHeader.parentNode.insertBefore(container, pageHeader.nextElementSibling);
        } else {
            document.querySelector('.main-content').appendChild(container);
        }
        return container;
    }

    // ========== FUNÇÕES PARA O MODAL DE RESET GERAL ==========

    function abrirModalReset() {
        const modal = document.getElementById('resetModal');
        if (modal) {
            modal.style.display = 'flex';
            document.body.style.overflow = 'hidden';

            // Resetar checkbox
            document.getElementById('confirmReset').checked = false;
            atualizarBotaoReset();
        }
    }

    function fecharModalReset() {
        const modal = document.getElementById('resetModal');
        if (modal) {
            modal.style.display = 'none';
            document.body.style.overflow = 'auto';
        }
    }

    function atualizarBotaoReset() {
        const confirmCheckbox = document.getElementById('confirmReset');
        const resetBtn = document.getElementById('resetConfirmBtn');

        if (confirmCheckbox && resetBtn) {
            if (confirmCheckbox.checked) {
                resetBtn.style.opacity = '1';
                resetBtn.style.pointerEvents = 'auto';
                resetBtn.style.cursor = 'pointer';
            } else {
                resetBtn.style.opacity = '0.5';
                resetBtn.style.pointerEvents = 'none';
                resetBtn.style.cursor = 'not-allowed';
            }
        }
    }

    function confirmReset() {
        if (!document.getElementById('confirmReset').checked) {
            alert('Por favor, marque a caixa de confirmação para prosseguir.');
            return false;
        }

        return confirm('CONFIRMAÇÃO FINAL: Tem certeza que deseja resetar TODOS os jogos concluídos? Esta ação NÃO pode ser desfeita.');
    }

    // Auto-remove flash messages existentes
    setTimeout(() => {
        const flashes = document.querySelectorAll('.flash');
        flashes.forEach(flash => {
            flash.style.opacity = '0';
            setTimeout(() => flash.remove(), 300);
        });
    }, 5000);

    // Event listeners
    document.getElementById('gameForm').addEventListener('submit', function(e) {
        console.log('Formulário sendo enviado...');
        console.log('Action:', this.action);
        console.log('Method:', this.method);
        console.log('Rodada:', document.getElementById('rodada_numero').value);
        console.log('Jogo ID:', document.getElementById('jogo_id').value);
    });

    document.getElementById('confirmReset')?.addEventListener('change', atualizarBotaoReset);

    // Fechar modal ao clicar fora
    document.getElementById('resetModal')?.addEventListener('click', function(e) {
        if (e.target === this) {
            fecharModalReset();
        }
    });

    // Fechar modal com ESC
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
            fecharModalReset();
        }
    });
</script>
</body>
</html>
<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Meus Palpites - Bolão dos Pescadores</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/palpites.css') }}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <div class="container">
        <!-- Header -->
        <header class="header">
            <div class="logo-container">
                <i class="fas fa-fish logo-icon"></i>
                <h1 class="logo">Bolão dos Pescadores</h1>
            </div>
            <nav class="nav-menu">
                <a href="{{ url_for('index') }}" class="nav-link">
                    <i class="fas fa-home"></i> Início
                </a>
                <a href="{{ url_for('palpites') }}" class="nav-link">
                    <i class="fas fa-edit"></i> Palpites
                </a>
                <a href="{{ url_for('meus_palpites') }}" class="nav-link active">
                    <i class="fas fa-history"></i> Meus Palpites
                </a>
                <div class="user-info">
                    <span class="user-name">
                        <i class="fas fa-user"></i>
                        {{ participante.nome }}
                    </span>
                </div>
            </nav>
        </header>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Page Header -->
            <div class="page-header">
                <div>
                    <h1><i class="fas fa-history"></i> Meus Palpites</h1>
                    <p class="page-subtitle">
                        Histórico completo de todos os seus palpites
                    </p>
                </div>
                <div class="header-stats">
                    <div class="mini-stat">
                        <i class="fas fa-list"></i>
                        <div>
                            <span class="mini-stat-number">{{ estatisticas.total_palpites }}</span>
                            <span class="mini-stat-label">Total</span>
                        </div>
                    </div>
                    <div class="mini-stat">
                        <i class="fas fa-star"></i>
                        <div>
                            <span class="mini-stat-number">{{ estatisticas.total_pe }}</span>
                            <span class="mini-stat-label">PE</span>
                        </div>
                    </div>
                    <div class="mini-stat">
                        <i class="fas fa-check"></i>
                        <div>
                            <span class="mini-stat-number">{{ estatisticas.total_pte }}</span>
                            <span class="mini-stat-label">PTE</span>
                        </div>
                    </div>
                    <div class="mini-stat">
                        <i class="fas fa-trophy"></i>
                        <div>
                            <span class="mini-stat-number">{{ estatisticas.total_pontos }}</span>
                            <span class="mini-stat-label">Pontos</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Estatísticas Gerais -->
            <div class="overall-stats">
                <div class="stat-card main-stat">
                    <div class="stat-icon">
                        <i class="fas fa-chart-line"></i>
                    </div>
                    <div class="stat-content">
                        <h3>Aproveitamento</h3>
                        <p class="stat-number">{{ estatisticas.aproveitamento }}%</p>
                        <p class="stat-label">Pontuação geral</p>
                    </div>
                </div>

                <div class="stat-card">
                    <div class="stat-icon">
                        <i class="fas fa-bullseye"></i>
                    </div>
                    <div class="stat-content">
                        <h3>Placares Exatos</h3>
                        <p class="stat-number">{{ estatisticas.total_pe }}</p>
                        <p class="stat-label">Acertos precisos</p>
                    </div>
                </div>

                <div class="stat-card">
                    <div class="stat-icon">
                        <i class="fas fa-check-double"></i>
                    </div>
                    <div class="stat-content">
                        <h3>Resultados</h3>
                        <p class="stat-number">{{ estatisticas.total_pte }}</p>
                        <p class="stat-label">Acertos de time</p>
                    </div>
                </div>

                <div class="stat-card">
                    <div class="stat-icon">
                        <i class="fas fa-coins"></i>
                    </div>
                    <div class="stat-content">
                        <h3>Pontos Totais</h3>
                        <p class="stat-number">{{ estatisticas.total_pontos }}</p>
                        <p class="stat-label">Pontuação acumulada</p>
                    </div>
                </div>
            </div>

            <!-- Lista de Palpites -->
            <div class="palpites-history">
                <div class="section-header">
                    <h3><i class="fas fa-futbol"></i> Histórico de Palpites</h3>
                    <div class="section-filters">
                        <select id="filterRodada" class="filter-select">
                            <option value="all">Todas as rodadas</option>
                            {% for rodada in range(1, 39) %}
                            <option value="{{ rodada }}">Rodada {{ rodada }}</option>
                            {% endfor %}
                        </select>

                        <select id="filterStatus" class="filter-select">
                            <option value="all">Todos os jogos</option>
                            <option value="concluido">Concluídos</option>
                            <option value="pendente">Pendentes</option>
                        </select>
                    </div>
                </div>

                {% if palpites %}
                    <div class="palpites-table-container">
                        <table class="palpites-table">
                            <thead>
                                <tr>
                                    <th>Rodada</th>
                                    <th>Jogo</th>
                                    <th>Data</th>
                                    <th>Seu Palpite</th>
                                    <th>Resultado</th>
                                    <th>Pontos</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for palpite in palpites %}
                                <tr class="palpite-row {% if palpite.status == 'Concluído' %}completed{% else %}pending{% endif %}">
                                    <td class="rodada-cell">
                                        <span class="rodada-badge">#{{ palpite.rodada }}</span>
                                    </td>
                                    <td class="jogo-cell">
                                        <div class="jogo-info">
                                            <div class="times">
                                                <span class="time">{{ palpite.time_casa }}</span>
                                                <span class="vs">vs</span>
                                                <span class="time">{{ palpite.time_visitante }}</span>
                                            </div>
                                            <small class="estadio">{{ palpite.estadio if palpite.estadio else 'Estádio a definir' }}</small>
                                        </div>
                                    </td>
                                    <td class="data-cell">
                                        {{ palpite.data if palpite.data else 'A definir' }}
                                        <br>
                                        <small>{{ palpite.horario }}</small>
                                    </td>
                                    <td class="palpite-cell">
                                        <span class="palpite-score {% if palpite.pontos == 3 %}exact{% elif palpite.pontos == 1 %}correct{% elif palpite.pontos == 0 %}wrong{% endif %}">
                                            {{ palpite.palpite_casa }} x {{ palpite.palpite_visitante }}
                                        </span>
                                        <br>
                                        <small>{{ palpite.data_palpite if palpite.data_palpite else 'Sem data' }}</small>
                                    </td>
                                    <td class="resultado-cell">
                                        {% if palpite.status == 'Concluído' and palpite.placar_casa is not none %}
                                            <span class="resultado-score">
                                                {{ palpite.placar_casa }} x {{ palpite.placar_visitante }}
                                            </span>
                                        {% else %}
                                            <span class="pending-result">Aguardando</span>
                                        {% endif %}
                                    </td>
                                    <td class="pontos-cell">
                                        {% if palpite.pontos is not none %}
                                            <div class="pontos-container">
                                                <span class="pontos-value {% if palpite.pontos == 3 %}exact{% elif palpite.pontos == 1 %}correct{% elif palpite.pontos == 0 %}wrong{% endif %}">
                                                    +{{ palpite.pontos }}
                                                </span>
                                                <div class="pontos-details">
                                                    <small>PE: {{ palpite.pe or 0 }}</small>
                                                    <small>PTE: {{ palpite.pte or 0 }}</small>
                                                </div>
                                            </div>
                                        {% else %}
                                            <span class="pending-points">-</span>
                                        {% endif %}
                                    </td>
                                    <td class="status-cell">
                                        <span class="status-badge {{ palpite.status|lower|replace(' ', '-') }}">
                                            {{ palpite.status }}
                                        </span>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>

                    <div class="table-footer">
                        <div class="summary">
                            <p>Mostrando {{ palpites|length }} palpites</p>
                        </div>
                        <div class="export-actions">
                            <button class="btn-export" onclick="exportarPalpites()">
                                <i class="fas fa-download"></i> Exportar
                            </button>
                        </div>
                    </div>
                {% else %}
                    <div class="empty-state">
                        <i class="fas fa-clipboard-list"></i>
                        <h3>Nenhum palpite registrado</h3>
                        <p>Você ainda não fez nenhum palpite. Vá para a página de palpites e comece a apostar!</p>
                        <a href="{{ url_for('palpites') }}" class="btn-primary">
                            <i class="fas fa-edit"></i> Fazer Palpites
                        </a>
                    </div>
                {% endif %}
            </div>

            <!-- Gráfico de Desempenho (simulado) -->
            <div class="performance-chart">
                <h3><i class="fas fa-chart-bar"></i> Desempenho por Rodada</h3>
                <div class="chart-container">
                    <canvas id="performanceChart"></canvas>
                </div>
            </div>
        </main>

        <!-- Footer -->
        <footer class="footer">
            <div class="footer-content">
                <div class="footer-section">
                    <h3>Meus Palpites</h3>
                    <p>Acompanhe seu desempenho no bolão</p>
                </div>
            </div>
            <div class="footer-bottom">
                <p>&copy; 2023 Bolão dos Pescadores</p>
            </div>
        </footer>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        // Filtros
        document.getElementById('filterRodada').addEventListener('change', function() {
            filterTable();
        });

        document.getElementById('filterStatus').addEventListener('change', function() {
            filterTable();
        });

        function filterTable() {
            const rodadaFilter = document.getElementById('filterRodada').value;
            const statusFilter = document.getElementById('filterStatus').value;

            document.querySelectorAll('.palpite-row').forEach(row => {
                const rodada = row.querySelector('.rodada-badge').textContent.replace('#', '');
                const status = row.querySelector('.status-badge').textContent;

                let showRow = true;

                if (rodadaFilter !== 'all' && rodada !== rodadaFilter) {
                    showRow = false;
                }

                if (statusFilter !== 'all') {
                    if (statusFilter === 'concluido' && status !== 'Concluído') {
                        showRow = false;
                    } else if (statusFilter === 'pendente' && status === 'Concluído') {
                        showRow = false;
                    }
                }

                row.style.display = showRow ? '' : 'none';
            });
        }

        // Exportar palpites
        function exportarPalpites() {
            const rows = [];

            // Cabeçalho
            rows.push(['Rodada', 'Time Casa', 'Time Visitante', 'Data', 'Palpite', 'Resultado', 'Pontos', 'PE', 'PTE']);

            // Dados
            document.querySelectorAll('.palpite-row').forEach(row => {
                if (row.style.display !== 'none') {
                    const rodada = row.querySelector('.rodada-badge').textContent;
                    const times = row.querySelectorAll('.time');
                    const data = row.querySelector('.data-cell').textContent.split('\n')[0];
                    const palpite = row.querySelector('.palpite-score').textContent;
                    const resultado = row.querySelector('.resultado-score')?.textContent || 'Aguardando';
                    const pontos = row.querySelector('.pontos-value')?.textContent.replace('+', '') || '0';
                    const pe = row.querySelector('.pontos-details small:nth-child(1)')?.textContent.replace('PE: ', '') || '0';
                    const pte = row.querySelector('.pontos-details small:nth-child(2)')?.textContent.replace('PTE: ', '') || '0';

                    rows.push([
                        rodada,
                        times[0].textContent,
                        times[1].textContent,
                        data.trim(),
                        palpite,
                        resultado,
                        pontos,
                        pe,
                        pte
                    ]);
                }
            });

            // Converter para CSV
            const csvContent = rows.map(row => row.join(';')).join('\n');
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');

            link.href = URL.createObjectURL(blob);
            link.download = `meus_palpites_${new Date().toISOString().split('T')[0]}.csv`;
            link.click();
        }

        // Gráfico de desempenho (simulado)
        function criarGrafico() {
            const ctx = document.getElementById('performanceChart').getContext('2d');

            // Dados simulados - depois virão do backend
            const dados = {
                labels: ['R1', 'R2', 'R3', 'R4', 'R5', 'R6', 'R7'],
                datasets: [{
                    label: 'Pontos por Rodada',
                    data: [4, 6, 3, 8, 5, 7, 6],
                    backgroundColor: 'rgba(54, 162, 235, 0.5)',
                    borderColor: 'rgba(54, 162, 235, 1)',
                    borderWidth: 2,
                    tension: 0.4
                }]
            };

            new Chart(ctx, {
                type: 'line',
                data: dados,
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'top',
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `Pontos: ${context.raw}`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 30,
                            title: {
                                display: true,
                                text: 'Pontos'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Rodada'
                            }
                        }
                    }
                }
            });
        }

        // Inicializar gráfico quando a página carregar
        document.addEventListener('DOMContentLoaded', criarGrafico);

        // Auto-remove flash messages
        setTimeout(() => {
            const flashes = document.querySelectorAll('.flash');
            flashes.forEach(flash => {
                flash.style.opacity = '0';
                setTimeout(() => flash.remove(), 300);
            });
        }, 5000);
    </script>
</body>
</html>